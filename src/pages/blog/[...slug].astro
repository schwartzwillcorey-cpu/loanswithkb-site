---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  // Only generate pages for published posts
  const publishedPosts = blogEntries.filter(post => !post.data.draft);

  return publishedPosts.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Calculate reading time
function getReadingTime(content: string): number {
  const words = content.split(/\s+/).length;
  return Math.ceil(words / 200);
}

// Format date
function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

const readingTime = getReadingTime(entry.body);

// Get related posts
async function getRelatedPosts(currentPost: CollectionEntry<'blog'>, limit: number = 2) {
  const allPosts = await getCollection('blog');
  const publishedPosts = allPosts.filter(
    post => !post.data.draft && post.slug !== currentPost.slug
  );

  // Calculate tag overlap score for each post
  const postsWithScores = publishedPosts.map(post => {
    const sharedTags = post.data.tags.filter(tag =>
      currentPost.data.tags.includes(tag)
    );
    return {
      post,
      score: sharedTags.length,
      date: post.data.pubDate.valueOf()
    };
  });

  // Sort by score (tag matches) first, then by date (most recent)
  postsWithScores.sort((a, b) => {
    if (b.score !== a.score) return b.score - a.score;
    return b.date - a.date;
  });

  return postsWithScores.slice(0, limit).map(item => item.post);
}

const relatedPosts = await getRelatedPosts(entry, 2);

// JSON-LD Article Schema
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": entry.data.title,
  "description": entry.data.description,
  "image": entry.data.featuredImage || "https://loanswithkb.com/assets/img/kelly-headshot.jpg",
  "datePublished": entry.data.pubDate.toISOString(),
  "dateModified": entry.data.pubDate.toISOString(),
  "author": {
    "@type": "Person",
    "name": entry.data.author,
    "jobTitle": "Mortgage Loan Officer",
    "identifier": {
      "@type": "PropertyValue",
      "propertyID": "NMLS",
      "value": "1786042"
    }
  },
  "publisher": {
    "@type": "Organization",
    "name": "Loans with KB",
    "logo": {
      "@type": "ImageObject",
      "url": "https://loanswithkb.com/assets/img/kelly-bergman-logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://loanswithkb.com/blog/${entry.slug}`
  }
};
---

<BaseLayout
  title={`${entry.data.title} | Loans with KB`}
  description={entry.data.description}
  canonical={`https://loanswithkb.com/blog/${entry.slug}`}
  ogType="article"
  ogImage={entry.data.featuredImage || "https://loanswithkb.com/assets/img/kelly-headshot.jpg"}
  jsonLd={jsonLd}
>
  <!-- Article Header -->
  <section class="page-hero blog-post-hero">
    <div class="container">
      <div class="blog-post-header">
        <div class="blog-post-meta">
          <time datetime={entry.data.pubDate.toISOString()}>
            {formatDate(entry.data.pubDate)}
          </time>
          <span class="blog-meta-divider">•</span>
          <span>{readingTime} min read</span>
          <span class="blog-meta-divider">•</span>
          <span>By {entry.data.author}</span>
        </div>

        <h1>{entry.data.title}</h1>

        {entry.data.tags.length > 0 && (
          <div class="blog-tags">
            {entry.data.tags.map(tag => (
              <span class="blog-tag">{tag}</span>
            ))}
          </div>
        )}
      </div>
    </div>
  </section>

  {entry.data.featuredImage && (
    <div class="featured-image-wrapper">
      <div class="container">
        <img src={entry.data.featuredImage} alt={entry.data.title} class="featured-image" />
      </div>
    </div>
  )}

  <!-- Article Content -->
  <article class="blog-post-content">
    <div class="container">
      <div class="prose">
        <Content />
      </div>

      <!-- Back to Blog Link -->
      <div class="blog-post-footer">
        <a href="/blog" class="back-to-blog">← Back to All Articles</a>
      </div>
    </div>
  </article>

  <!-- Related Articles Section -->
  {relatedPosts.length > 0 && (
    <section class="related-articles-section">
      <div class="container">
        <h2 class="section-heading">Continue Reading</h2>
        <div class="related-articles-grid">
          {relatedPosts.map((post) => {
            const postReadingTime = getReadingTime(post.body);
            return (
              <article class="related-article-card">
                <div class="blog-post-meta">
                  <time datetime={post.data.pubDate.toISOString()}>
                    {formatDate(post.data.pubDate)}
                  </time>
                  <span class="blog-meta-divider">•</span>
                  <span>{postReadingTime} min read</span>
                </div>

                <h3 class="related-article-title">
                  <a href={`/blog/${post.slug}`}>{post.data.title}</a>
                </h3>

                <p class="related-article-excerpt">{post.data.description}</p>

                {post.data.tags.length > 0 && (
                  <div class="blog-tags">
                    {post.data.tags.slice(0, 3).map(tag => (
                      <span class="blog-tag">{tag}</span>
                    ))}
                  </div>
                )}

                <a href={`/blog/${post.slug}`} class="blog-read-more">
                  Read Article →
                </a>
              </article>
            );
          })}
        </div>
      </div>
    </section>
  )}

  <!-- Subscribe Section -->
  <section class="subscribe-section">
    <div class="container">
      <div class="subscribe-card">
        <h2 class="subscribe-heading">Get Updates on New Guides</h2>
        <p class="subscribe-description">
          Subscribe to receive helpful mortgage guides and market updates for Texas homebuyers and homeowners. No spam. Unsubscribe anytime.
        </p>
        <form class="subscribe-form" id="subscribe-form" action="https://n8n.meridian-automations.com/webhook/5927d2ff-8df9-4577-871e-6b0c85d8a44a" method="POST">
          <div class="subscribe-input-group">
            <input
              type="email"
              name="email"
              placeholder="Enter your email"
              required
              class="subscribe-input"
              aria-label="Email address"
            />
            <button type="submit" class="btn btn-primary subscribe-button">
              Subscribe
            </button>
          </div>
          <p class="subscribe-privacy">
            We respect your privacy. Unsubscribe at any time.
          </p>
          <p id="subscribe-message" class="subscribe-message" style="display: none;"></p>
        </form>
      </div>
    </div>
  </section>

  <!-- Related Links Section -->
  <section style="padding: var(--spacing-4xl) 0; background: var(--color-soft-gray);">
    <div class="container">
      <div class="content-block centered">
        <h2>Explore More</h2>
        <div class="related-links">
          <a href="/#mortgage-calculator" class="related-link-card">
            <h3>Mortgage Calculator</h3>
            <p>Get an instant estimate of your monthly payment</p>
          </a>
          <a href="/#faq" class="related-link-card">
            <h3>Common Questions</h3>
            <p>Find answers to frequently asked mortgage questions</p>
          </a>
          <a href="/contact.html" class="related-link-card">
            <h3>Schedule a Call</h3>
            <p>Get personalized guidance for your situation</p>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="final-cta">
    <div class="container">
      <div class="final-cta-content">
        <h2>Let's talk about your mortgage goals.</h2>
        <p>Whether you're just exploring options or ready to move forward, I'm here to provide clear guidance with zero pressure.</p>
        <a href="/contact.html" class="btn btn-primary btn-lg">Schedule a Discovery Call</a>
      </div>
    </div>
  </section>

  <!-- Back to Top Button -->
  <button id="back-to-top" class="back-to-top" aria-label="Back to top" style="display: none;">
    <span aria-hidden="true">↑</span>
  </button>
</BaseLayout>

<style>
  /* Blog Post Hero - Light background with subtle separation */
  .blog-post-hero {
    background: var(--color-soft-gray);
    border-bottom: 1px solid var(--color-border);
  }

  .blog-post-header {
    max-width: 800px;
    margin: 0 auto;
  }

  .blog-post-header h1 {
    position: relative;
    padding-bottom: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    border-bottom: 1px solid var(--color-accent);
  }

  .blog-post-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.95rem;
    color: var(--color-text-light);
    margin-bottom: var(--spacing-lg);
  }

  .blog-meta-divider {
    color: var(--color-border);
  }

  .blog-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    margin-top: var(--spacing-lg);
  }

  .blog-tag {
    display: inline-block;
    padding: var(--spacing-xs) var(--spacing-md);
    background: var(--color-soft-gray);
    color: var(--color-text-gray);
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    font-weight: var(--font-weight-medium);
    transition: var(--transition-base);
    cursor: default;
  }

  .blog-tag:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: rgba(255, 62, 165, 0.05);
  }

  .blog-post-content {
    padding: var(--spacing-5xl) 0;
    background: var(--color-white);
  }

  .prose {
    max-width: 760px;
    margin: 0 auto;
    font-size: 1.125rem;
    line-height: 1.8;
    color: var(--color-text-gray);
  }

  .prose :global(h2) {
    font-size: 2rem;
    color: var(--color-primary);
    margin-top: var(--spacing-4xl);
    margin-bottom: var(--spacing-lg);
    line-height: 1.3;
  }

  .prose :global(h3) {
    font-size: 1.5rem;
    color: var(--color-primary);
    margin-top: var(--spacing-3xl);
    margin-bottom: var(--spacing-md);
  }

  .prose :global(p) {
    margin-bottom: var(--spacing-lg);
  }

  .prose :global(h1) {
    font-size: 2.25rem;
    color: var(--color-primary);
    margin-top: 0;
    margin-bottom: var(--spacing-xl);
    line-height: 1.2;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin-bottom: var(--spacing-lg);
    padding-left: var(--spacing-xl);
  }

  .prose :global(ul) {
    list-style: disc;
  }

  .prose :global(ol) {
    list-style: decimal;
  }

  .prose :global(li) {
    margin-bottom: var(--spacing-sm);
  }

  .prose :global(strong) {
    color: var(--color-primary);
    font-weight: var(--font-weight-semibold);
  }

  .prose :global(a) {
    color: var(--color-accent);
    text-decoration: underline;
    transition: var(--transition-base);
  }

  .prose :global(a:hover) {
    color: var(--color-accent-hover);
  }

  .prose :global(blockquote) {
    border-left: 4px solid var(--color-accent);
    padding-left: var(--spacing-lg);
    margin: var(--spacing-2xl) 0;
    font-style: italic;
    color: var(--color-text-gray);
  }

  .prose :global(code) {
    background: var(--color-soft-gray);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Courier New', monospace;
  }

  .blog-post-footer {
    max-width: 760px;
    margin: var(--spacing-4xl) auto 0;
    padding-top: var(--spacing-2xl);
    border-top: 1px solid rgba(255, 62, 165, 0.15);
  }

  .back-to-blog {
    display: inline-flex;
    align-items: center;
    color: var(--color-accent);
    font-weight: var(--font-weight-semibold);
    transition: var(--transition-base);
  }

  .back-to-blog:hover {
    color: var(--color-accent-hover);
    transform: translateX(-4px);
  }

  /* Related Articles Section */
  .related-articles-section {
    padding: var(--spacing-5xl) 0;
    background: var(--color-white);
  }

  .section-heading {
    font-size: 2rem;
    text-align: center;
    margin-bottom: var(--spacing-3xl);
    color: var(--color-primary);
    position: relative;
    padding-bottom: var(--spacing-md);
  }

  .section-heading::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 3px;
    background: var(--color-accent);
    border-radius: 2px;
  }

  .related-articles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-2xl);
    max-width: var(--container-max);
    margin: 0 auto;
  }

  .related-article-card {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    transition: var(--transition-smooth);
    display: flex;
    flex-direction: column;
  }

  .related-article-card:hover {
    border-color: var(--color-accent);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .related-article-title {
    font-size: 1.25rem;
    line-height: 1.3;
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid var(--color-accent);
  }

  .related-article-title a {
    color: var(--color-primary);
    transition: var(--transition-base);
  }

  .related-article-title a:hover {
    color: var(--color-accent);
  }

  .related-article-excerpt {
    color: var(--color-text-gray);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: var(--spacing-md);
    flex-grow: 1;
  }

  .related-links {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: var(--spacing-xl);
    margin-top: var(--spacing-2xl);
  }

  .related-link-card {
    background: var(--color-white);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--spacing-xl);
    transition: var(--transition-smooth);
    text-align: center;
  }

  .related-link-card:hover {
    border-color: var(--color-accent);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .related-link-card h3 {
    font-size: 1.25rem;
    color: var(--color-primary);
    margin-bottom: var(--spacing-sm);
  }

  .related-link-card p {
    color: var(--color-text-light);
    font-size: 0.95rem;
    margin: 0;
  }

  /* Featured Image */
  .featured-image-wrapper {
    background: var(--color-white);
    padding: var(--spacing-2xl) 0 0;
  }

  .featured-image {
    max-width: 800px;
    margin: 0 auto;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
  }

  /* Back to Top Button */
  .back-to-top {
    position: fixed;
    bottom: var(--spacing-xl);
    right: var(--spacing-xl);
    width: 48px;
    height: 48px;
    background: var(--color-text-gray);
    color: var(--color-white);
    border: none;
    border-radius: var(--radius-md);
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    transition: var(--transition-smooth);
    z-index: 800;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transform: translateY(10px);
  }

  .back-to-top.visible {
    opacity: 1;
    transform: translateY(0);
  }

  .back-to-top:hover {
    background: var(--color-primary);
    box-shadow: var(--shadow-xl);
    transform: translateY(-2px);
  }

  .back-to-top:active {
    transform: translateY(0);
  }

  .back-to-top:focus-visible {
    outline: 3px solid rgba(68, 68, 68, 0.4);
    outline-offset: 2px;
  }

  /* Subscribe Section */
  .subscribe-section {
    padding: var(--spacing-5xl) 0;
    background: var(--color-white);
  }

  .subscribe-card {
    max-width: 600px;
    margin: 0 auto;
    text-align: center;
    padding: var(--spacing-3xl);
    background: var(--color-soft-gray);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .subscribe-heading {
    font-size: 1.75rem;
    color: var(--color-primary);
    margin-bottom: var(--spacing-md);
    line-height: 1.3;
  }

  .subscribe-description {
    font-size: 1rem;
    color: var(--color-text-gray);
    line-height: 1.6;
    margin-bottom: var(--spacing-xl);
  }

  .subscribe-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }

  .subscribe-input-group {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .subscribe-input {
    flex: 1;
    min-width: 250px;
    padding: var(--spacing-md) var(--spacing-lg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: 1rem;
    transition: var(--transition-base);
    background: var(--color-white);
  }

  .subscribe-input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px rgba(255, 62, 165, 0.1);
  }

  .subscribe-button {
    white-space: nowrap;
  }

  .subscribe-privacy {
    font-size: 0.875rem;
    color: var(--color-text-light);
    margin: 0;
  }

  .subscribe-message {
    font-size: 0.9375rem;
    font-weight: var(--font-weight-medium);
    margin-top: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    background: rgba(255, 255, 255, 0.5);
  }

  @media (max-width: 768px) {
    .prose {
      font-size: 1.0625rem;
    }

    .prose :global(h1) {
      font-size: 1.75rem;
    }

    .prose :global(h2) {
      font-size: 1.5rem;
    }

    .prose :global(h3) {
      font-size: 1.25rem;
    }

    .section-heading {
      font-size: 1.75rem;
    }

    .related-articles-grid {
      grid-template-columns: 1fr;
      gap: var(--spacing-xl);
    }

    .related-article-card {
      padding: var(--spacing-lg);
    }

    .related-article-title {
      font-size: 1.125rem;
    }

    .related-links {
      grid-template-columns: 1fr;
    }

    .back-to-top {
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      width: 44px;
      height: 44px;
      font-size: 1.25rem;
    }

    .subscribe-card {
      padding: var(--spacing-2xl) var(--spacing-lg);
    }

    .subscribe-heading {
      font-size: 1.5rem;
    }

    .subscribe-input-group {
      flex-direction: column;
    }

    .subscribe-input {
      min-width: 100%;
    }

    .subscribe-button {
      width: 100%;
    }
  }
</style>

<script>
  // Back to Top Button Logic
  const backToTopButton = document.getElementById('back-to-top');

  if (backToTopButton) {
    // Show/hide button based on scroll position
    const handleScroll = () => {
      const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;

      if (scrollPercent > 25 && scrollPercent < 95) {
        backToTopButton.style.display = 'flex';
        setTimeout(() => backToTopButton.classList.add('visible'), 10);
      } else {
        backToTopButton.classList.remove('visible');
        setTimeout(() => {
          if (!backToTopButton.classList.contains('visible')) {
            backToTopButton.style.display = 'none';
          }
        }, 300);
      }
    };

    // Scroll to top on click
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });

    // Listen for scroll events (throttled)
    let scrollTimeout: ReturnType<typeof setTimeout> | undefined;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(handleScroll, 50);
    }, { passive: true });

    // Initial check
    handleScroll();
  }

  // Subscribe Form Handling
  const subscribeForm = document.getElementById('subscribe-form') as HTMLFormElement;
  const subscribeMessage = document.getElementById('subscribe-message') as HTMLParagraphElement;
  const subscribeButton = subscribeForm?.querySelector('.subscribe-button') as HTMLButtonElement;

  if (subscribeForm) {
    subscribeForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(subscribeForm);
      const email = formData.get('email') as string;

      // Disable button during submission
      if (subscribeButton) {
        subscribeButton.disabled = true;
        subscribeButton.textContent = 'Subscribing...';
      }

      try {
        const response = await fetch(subscribeForm.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email })
        });

        if (response.ok) {
          // Success
          subscribeMessage.textContent = 'Thanks for subscribing! Check your email for confirmation.';
          subscribeMessage.style.display = 'block';
          subscribeMessage.style.color = 'var(--color-primary)';
          subscribeForm.reset();
        } else {
          // Error
          subscribeMessage.textContent = 'Something went wrong. Please try again.';
          subscribeMessage.style.display = 'block';
          subscribeMessage.style.color = '#d32f2f';
        }
      } catch (error) {
        // Network error
        subscribeMessage.textContent = 'Network error. Please check your connection and try again.';
        subscribeMessage.style.display = 'block';
        subscribeMessage.style.color = '#d32f2f';
      } finally {
        // Re-enable button
        if (subscribeButton) {
          subscribeButton.disabled = false;
          subscribeButton.textContent = 'Subscribe';
        }
      }
    });
  }
</script>
